<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SSOSecurityConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">myspringjwt</a> &gt; <a href="index.source.html" class="el_package">com.example.jwt.security</a> &gt; <span class="el_source">SSOSecurityConfig.java</span></div><h1>SSOSecurityConfig.java</h1><pre class="source lang-java linenums">package com.example.jwt.security;

import java.io.IOException;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.web.servlet.FilterRegistrationBean;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.builders.WebSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.AuthenticationEntryPoint;
import org.springframework.security.web.authentication.ForwardAuthenticationFailureHandler;
import org.springframework.security.web.authentication.Http403ForbiddenEntryPoint;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.security.web.util.matcher.AntPathRequestMatcher;


/**
 * Copyright (c) 2018 NTT DATA Corporation
 *
 * @author 159719 30 Jul 2018
 *
 */
@Configuration
@EnableWebSecurity
<span class="nc" id="L34">public class SSOSecurityConfig extends WebSecurityConfigurerAdapter {</span>

	public static final String SSO_ENTRY_POINT = &quot;/api/sso/**&quot;;
    public static final String CFD_ENTRY_POINT = &quot;/api/cfd/**&quot;;
    public static final String WALLET_ENTRY_POINT = &quot;/api/wallet/**&quot;;
    public static final String GATEWAY_ENTRY_POINT = &quot;/api/gateway/**&quot;;
    
    public static final String TOKEN_BASED_AUTH_ENTRY_POINT = &quot;/ssologin&quot;;
	
	@Autowired
	private LoggingAccessDeniedHandler accessDeniedHandler;
	

	@Override
	public void configure(WebSecurity  web) throws Exception {
		 
<span class="nc" id="L50">		 web.ignoring().antMatchers(SSO_ENTRY_POINT);</span>
<span class="nc" id="L51">		 web.ignoring().antMatchers(CFD_ENTRY_POINT);</span>
<span class="nc" id="L52">		 web.ignoring().antMatchers(WALLET_ENTRY_POINT);</span>
<span class="nc" id="L53">		 web.ignoring().antMatchers(GATEWAY_ENTRY_POINT);</span>
<span class="nc" id="L54">	 }</span>
		
		 
	@Override
	protected void configure(HttpSecurity http) throws Exception {
<span class="nc" id="L59">		http	</span>
<span class="nc" id="L60">		.authorizeRequests()</span>
<span class="nc" id="L61">		.antMatchers(&quot;/js/**&quot;, &quot;/css/**&quot;, &quot;/img/**&quot;).permitAll()</span>
<span class="nc" id="L62">		.antMatchers(&quot;/user/**&quot;)</span>
<span class="nc" id="L63">		.hasAuthority(&quot;USER&quot;)					</span>
<span class="nc" id="L64">	 .and()</span>
<span class="nc" id="L65">	 	.logout()</span>
<span class="nc" id="L66">	 	.invalidateHttpSession(true)</span>
<span class="nc" id="L67">	 	.clearAuthentication(true)</span>
<span class="nc" id="L68">	 	.logoutRequestMatcher(new AntPathRequestMatcher(&quot;/logout&quot;))</span>
<span class="nc" id="L69">	 	.logoutSuccessUrl(&quot;/logoutsuccessful&quot;)</span>
<span class="nc" id="L70">	 	.permitAll()</span>
<span class="nc" id="L71">	 .and()	</span>
<span class="nc" id="L72">	 	.exceptionHandling()</span>
<span class="nc" id="L73">	 	.accessDeniedHandler(accessDeniedHandler)</span>
<span class="nc" id="L74">	 	.defaultAuthenticationEntryPointFor(new RestAuthenticationEntryPoint(), new AntPathRequestMatcher(&quot;/api/**&quot;))</span>
<span class="nc" id="L75">	 	.authenticationEntryPoint(new Http403ForbiddenEntryPoint())</span>
<span class="nc" id="L76">	  .and()</span>
<span class="nc" id="L77">	 	.headers()</span>
<span class="nc" id="L78">	 		.frameOptions().disable()</span>
<span class="nc" id="L79">	 		.xssProtection().block(false);</span>
	
		
<span class="nc" id="L82">	   http.addFilterBefore(authenticationTokenFilterBean(), UsernamePasswordAuthenticationFilter.class);</span>

<span class="nc" id="L84">	}</span>
	
	@Bean
    public AuthenticationManager authenticationManagerBean() throws Exception {
<span class="nc" id="L88">		return super.authenticationManagerBean();</span>
    }
	
	@Bean
    public JwtAuthenticationFilter authenticationTokenFilterBean() throws Exception {
		
<span class="nc" id="L94">        JwtAuthenticationFilter filter </span>
            = new JwtAuthenticationFilter();
<span class="nc" id="L96">        filter.setAuthenticationManager(authenticationManagerBean());</span>
<span class="nc" id="L97">        filter.setAuthenticationFailureHandler(new ForwardAuthenticationFailureHandler(&quot;/authfailure&quot;));</span>
<span class="nc" id="L98">        return filter;        </span>
       
    }
	
<span class="nc" id="L102">	class RestAuthenticationEntryPoint implements AuthenticationEntryPoint {</span>

		public void commence(HttpServletRequest request, HttpServletResponse response,
				AuthenticationException authenticationException) throws IOException, ServletException {
<span class="nc" id="L106">			System.out.println(&quot;In RestAuthenticationEntryPoint:: commence&quot;);</span>
			
<span class="nc" id="L108">			response.setContentType(&quot;application/json&quot;);</span>
<span class="nc" id="L109">			response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);</span>
<span class="nc" id="L110">			response.getOutputStream().println(&quot;{ \&quot;error\&quot;: \&quot;&quot; + authenticationException.getMessage() + &quot;\&quot; }&quot;);</span>

<span class="nc" id="L112">		}</span>

	}
	
	@Bean
	public FilterRegistrationBean&lt;JwtAuthenticationFilter&gt; jwtFilter() throws Exception {
<span class="nc" id="L118">		final FilterRegistrationBean&lt;JwtAuthenticationFilter&gt; registrationBean = new FilterRegistrationBean&lt;JwtAuthenticationFilter&gt;();</span>
<span class="nc" id="L119">		registrationBean.setFilter(authenticationTokenFilterBean());</span>
<span class="nc" id="L120">		registrationBean.addUrlPatterns(&quot;/*&quot;);</span>
		// set as false to avoid multiple filter calls
<span class="nc" id="L122">		registrationBean.setEnabled(false);</span>
<span class="nc" id="L123">		return registrationBean;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>